#include "delay.h"
#include "sys.h"
////////////////////////////////////////////////////////////////////////////////// 	 
//?????????OS,??????????????????. 
#if SYSTEM_SUPPORT_OS
#include "includes.h"					//ucos ???	  
#endif
//////////////////////////////////////////////////////////////////////////////////	 
//???????????????¦Ä????????????????????????¦Ê????
//ALIENTEK STM32??????
//???SysTick??????????????????§Û????????STM32F10x??§µ?
//????delay_us,delay_ms
//???????@ALIENTEK
//???????:www.openedv.com
//????????:2019/9/17
//?·Ú??V1.8
//??????§µ?????????
//Copyright(C) ?????????????????????? 2009-2019
//All rights reserved
//********************************************************************************
//V1.2??????
//???????§Ø??§Ö??¨®?????????????
//??????????,????do while??!
//V1.3??????
//???????UCOSII????????.
//??????ucosII,delay_init?????????SYSTICK???,????ucos??TICKS_PER_SEC???.
//delay_ms??delay_us??????????ucos?????.
//delay_us??????ucos?????,??????????,???????????????????????.
//delay_ms??ucos??,???????OSTimeDly????,??¦Ä????ucos?,??????delay_us???,????????
//?????????????????,????????ucos???delay_ms????????????,???OSTimeDly??????delay_us???.
//V1.4?????? 20110929
//????????ucos,????ucos¦Ä?????????,delay_ms???§Ø?????????bug.
//V1.5?????? 20120902
//??delay_us????ucos?????????????ucos???delay_us????§µ?????????????????
//V1.6?????? 20150109
//??delay_ms????OSLockNesting?§Ø??
//V1.7?????? 20150319
//???OS?????,?????????OS(??????UCOSII??UCOSIII,??????????OS?????????)
//????:delay_osrunning/delay_ostickspersec/delay_osintnesting????????
//????:delay_osschedlock/delay_osschedunlock/delay_ostimedly????????
//V1.8?????? 20150519
//????UCOSIII??????2??bug??
//delay_tickspersec?????delay_ostickspersec
//delay_intnesting?????delay_osintnesting
//////////////////////////////////////////////////////////////////////////////////  

static u32 fac_us=0;							//us?????????

#if SYSTEM_SUPPORT_OS		
    static u16 fac_ms=0;				        //ms?????????,??os??,????????????ms??
#endif
	
#if SYSTEM_SUPPORT_OS							//???SYSTEM_SUPPORT_OS??????,???????OS??(??????UCOS).
//??delay_us/delay_ms??????OS??????????????OS????????????????
//??????3??????:
//    delay_osrunning:??????OS??????????????,????????????????????
//delay_ostickspersec:??????OS?Ú…????????,delay_init????????????????????systick
// delay_osintnesting:??????OS?§Ø???????,????§Ø????ÖÎ???????,delay_ms???¨°????????????????
//?????3??????:
//  delay_osschedlock:????????OS???????,???????
//delay_osschedunlock:???????OS???????,???????????
//    delay_ostimedly:????OS???,???????????????.

//?????????UCOSII??UCOSIII?????,????OS,?????§Ó¦Ï??????
//???UCOSII
#ifdef 	OS_CRITICAL_METHOD						//OS_CRITICAL_METHOD??????,???????UCOSII				
#define delay_osrunning		OSRunning			//OS??????§Ò??,0,??????;1,??????
#define delay_ostickspersec	OS_TICKS_PER_SEC	//OS??????,???????????
#define delay_osintnesting 	OSIntNesting		//?§Ø???????,???§Ø???????
#endif

//???UCOSIII
#ifdef 	CPU_CFG_CRITICAL_METHOD					//CPU_CFG_CRITICAL_METHOD??????,???????UCOSIII	
#define delay_osrunning		OSRunning			//OS??????§Ò??,0,??????;1,??????
#define delay_ostickspersec	OSCfg_TickRate_Hz	//OS??????,???????????
#define delay_osintnesting 	OSIntNestingCtr		//?§Ø???????,???§Ø???????
#endif


//us??????,??????????(??????us?????)
void delay_osschedlock(void)
{
#ifdef CPU_CFG_CRITICAL_METHOD   				//???UCOSIII
	OS_ERR err; 
	OSSchedLock(&err);							//UCOSIII????,??????????????us???
#else											//????UCOSII
	OSSchedLock();								//UCOSII????,??????????????us???
#endif
}

//us??????,??????????
void delay_osschedunlock(void)
{	
#ifdef CPU_CFG_CRITICAL_METHOD   				//???UCOSIII
	OS_ERR err; 
	OSSchedUnlock(&err);						//UCOSIII????,???????
#else											//????UCOSII
	OSSchedUnlock();							//UCOSII????,???????
#endif
}

//????OS???????????????
//ticks:??????????
void delay_ostimedly(u32 ticks)
{
#ifdef CPU_CFG_CRITICAL_METHOD
	OS_ERR err; 
	OSTimeDly(ticks,OS_OPT_TIME_PERIODIC,&err);	//UCOSIII?????????????
#else
	OSTimeDly(ticks);							//UCOSII???
#endif 
}
 
//systick?§Ø??????,???ucos????
void SysTick_Handler(void)
{	
	if(delay_osrunning==1)						//OS???????,?????????????????
	{
		OSIntEnter();							//?????§Ø?
		OSTimeTick();       					//????ucos???????????               
		OSIntExit();       	 					//?????????§Ý????§Ø?
	}
}
#endif

			   
//???????????
//?????ucos?????,???????????ucos????????
//SYSTICK????????AHB???
//SYSCLK:????????
void delay_init(u8 SYSCLK)
{
#if SYSTEM_SUPPORT_OS 						//?????????OS.
	u32 reload;
#endif
    HAL_SYSTICK_CLKSourceConfig(SYSTICK_CLKSOURCE_HCLK);//SysTick????HCLK
	fac_us=SYSCLK;						//??????????OS,fac_us????????
#if SYSTEM_SUPPORT_OS 						//?????????OS.
	reload=SYSCLK;					    //????????????? ??¦Ë?K	   
	reload*=1000000/delay_ostickspersec;	//????delay_ostickspersec?Ú…??????
											//reload?24¦Ë?????,????:16777216,??72M??,???0.233s????	
	fac_ms=1000/delay_ostickspersec;		//????OS??????????????¦Ë	   
	SysTick->CTRL|=SysTick_CTRL_TICKINT_Msk;//????SYSTICK?§Ø?
	SysTick->LOAD=reload; 					//?1/OS_TICKS_PER_SEC???§Ø????	
	SysTick->CTRL|=SysTick_CTRL_ENABLE_Msk; //????SYSTICK
#else
#endif
}								    

#if SYSTEM_SUPPORT_OS 						//?????????OS.
//???nus
//nus:??????us??.	
//nus:0~190887435(??????2^32/fac_us@fac_us=22.5)	    								   
void delay_us(u32 nus)
{		
	u32 ticks;
	u32 told,tnow,tcnt=0;
	u32 reload=SysTick->LOAD;				//LOAD???	    	 
	ticks=nus*fac_us; 						//?????????? 
	delay_osschedlock();					//???OS???????????us???
	told=SysTick->VAL;        				//??????????????
	while(1)
	{
		tnow=SysTick->VAL;	
		if(tnow!=told)
		{	    
			if(tnow<told)tcnt+=told-tnow;	//??????????SYSTICK??????????????????????.
			else tcnt+=reload-tnow+told;	    
			told=tnow;
			if(tcnt>=ticks)break;			//?????/????????????,?????.
		}  
	};
	delay_osschedunlock();					//???OS????											    
}  
//???nms
//nms:??????ms??
//nms:0~65535
void delay_ms(u16 nms)
{	
	if(delay_osrunning&&delay_osintnesting==0)//???OS?????????,??????????§Ø?????(?§Ø????ÖÎ?????????)	    
	{		 
		if(nms>=fac_ms)						//???????????OS????????????? 
		{ 
   			delay_ostimedly(nms/fac_ms);	//OS???
		}
		nms%=fac_ms;						//OS???????????§³???????,?????????????    
	}
	delay_us((u32)(nms*1000));				//?????????
}
#else  //????ucos?

//???nus
//nus???????us??.	
//nus:0~190887435(??????2^32/fac_us@fac_us=22.5)	 
void delay_us(u32 nus)
{		
	u32 ticks;
	u32 told,tnow,tcnt=0;
	u32 reload=SysTick->LOAD;				//LOAD???	    	 
	ticks=nus*fac_us; 						//?????????? 
	told=SysTick->VAL;        				//??????????????
	while(1)
	{
		tnow=SysTick->VAL;	
		if(tnow!=told)
		{	    
			if(tnow<told)tcnt+=told-tnow;	//??????????SYSTICK??????????????????????.
			else tcnt+=reload-tnow+told;	    
			told=tnow;
			if(tcnt>=ticks)break;			//?????/????????????,?????.
		}  
	};
}

//???nms
//nms:??????ms??
void delay_ms(u16 nms)
{
	u32 i;
	for(i=0;i<nms;i++) delay_us(1000);
}
#endif








































